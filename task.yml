- name: ec2 launcher
  hosts: localhost
  connection: local
  become: False
  tasks:
  - name: launching ec2
    ec2:
      aws_access_key: "{{ ec2_access_key }}"
      aws_secret_key: "{{ ec2_secret_key }}"
      key_name: "{{ key_name }}"
      instance_type: "{{ instance_type }}"
      image: "{{ image }}"
      region: "{{ region }}"
      wait: yes
      group: default
      count: 1
      vpc_subnet_id: "{{ vpc_subnet_id }}"
      wait: yes
      assign_public_ip: yes
    register: ec2

  - name: Add new instance to host group
    add_host:
      hostname: "{{ item.public_ip }}"
      groupname: launched
    loop: "{{ ec2.instances }}"

  - name: Wait for SSH to come up
    delegate_to: "{{ item.public_dns_name }}"
    wait_for_connection:
      delay: 60
      timeout: 320
    loop: "{{ ec2.instances }}"

- name: Configure instance(s)
  hosts: launched
  become: True
  gather_facts: True
  tasks:
  - name: Transfer executable script
    copy: src=prepare_env.sh dest=~ mode=0777
    when: master_node is defined

  - name: Execute the script
    command: sh ~/prepare_env.sh
    when: master_node is defined


  - name: Transfer executable script
    copy: src=prepare_env.sh dest=~ mode=0777
    when: master_node is defined

  - name: Execute the script
    command: sh ~/prepare_env.sh
    when: master_node is defined

# - name: Terminate instances
#   hosts: localhost
#   tasks:
#     - name: Terminate instances that were previously launched
#       ec2:
#         state: 'absent'
#         region: '{{ region }}'
#         aws_access_key: "{{ ec2_access_key }}"
#         aws_secret_key: "{{ ec2_secret_key }}"
#         instance_ids: '{{ ec2.instance_ids }}'